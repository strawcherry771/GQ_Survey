// src/pages/ResultPage.jsx
import { useParams } from 'react-router-dom';
import { useEffect, useState } from 'react';
import { Radar } from 'react-chartjs-2';
import { Chart, RadialLinearScale, PointElement, LineElement, Filler, Tooltip } from 'chart.js';
import { calculateCategoryScores } from '../utils/scoreByCategory';
import { getSummaryMessage } from '../utils/gqSummary';
import { analyzeShapeAndGrowth } from '../utils/gqShape';
import { recommendations } from '../utils/gqRecommendations';
import { db } from '../firebase';
import { collection, addDoc, doc, updateDoc } from 'firebase/firestore';
import { getGrowthStage } from '../utils/getGrowthStage';


Chart.register(RadialLinearScale, PointElement, LineElement, Filler, Tooltip);

// Îã§Íµ≠Ïñ¥ ÌÖçÏä§Ìä∏
const TEXTS = {
  ko: {
    resultTitle: 'üéâ GQ ÌÖåÏä§Ìä∏ Í≤∞Í≥º',
    totalScore: 'Ï¥ùÏ†ê',
    growthStage: 'ÏÑ±Ïû• Îã®Í≥Ñ',
    growthDesc: 'ÏÑ§Î™Ö',
    summary: 'üß© Ï¢ÖÌï© Ìï¥ÏÑù Î©îÏãúÏßÄ',
    areaAnalysis: 'üìå ÏòÅÏó≠Î≥Ñ Î∂ÑÏÑù',
    shape: 'üìê Shape Î∂ÑÏÑù',
    recs: 'üí° Ï∂îÏ≤ú ÌôúÎèô',
    feedbackTitle: 'üó£Ô∏è Ïù¥Î≤à ÌÖåÏä§Ìä∏Îäî Ïñ¥Îï†ÎÇòÏöî?',
    feedbackScore: 'ÎßåÏ°±ÎèÑÎ•º 1~5Ï†êÏúºÎ°ú ÌèâÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî:',
    feedbackPlaceholder: 'ÌîºÎìúÎ∞±Ïù¥ ÏûàÎã§Î©¥ Ï†ÅÏñ¥Ï£ºÏÑ∏Ïöî (ÏÑ†ÌÉù ÏÇ¨Ìï≠)',
    feedbackSubmit: 'ÌîºÎìúÎ∞± Ï†úÏ∂ú',
    feedbackThanks: 'ÌîºÎìúÎ∞± Í∞êÏÇ¨Ìï©ÎãàÎã§!',
    feedbackError: 'Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.',
    feedbackAlert: 'Î®ºÏ†Ä ÏÑ§Î¨∏Ïù¥ Ï†ÄÏû•ÎêòÏñ¥Ïïº Ìï©ÎãàÎã§.',
    level: 'Î†àÎ≤®',
    percent: '%',
    score: 'Ï†êÏàò',
    area: 'ÏòÅÏó≠',
    personalFeedback: 'Í∞úÎ≥Ñ ÌîºÎìúÎ∞±',
    shapeType: 'ÎèÑÌòï Ïú†Ìòï',
    areaLabel: area => area.replace('GQ-', ''),
    description: 'ÏÑ§Î™Ö',
    submitDisabled: 'ÎßåÏ°±ÎèÑ Ï†êÏàòÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.',
    tableHeaders: ['ÏòÅÏó≠', 'Ï†êÏàò', '%', 'Î†àÎ≤®', 'Í∞úÎ≥Ñ ÌîºÎìúÎ∞±'],
    shapeDetail: ['ÎèÑÌòï Ïú†Ìòï', 'ÏÑ§Î™Ö', 'Î©¥Ï†Å', 'ÌëúÏ§ÄÌé∏Ï∞®', 'Í∑πÍ∞íÏ∞®', 'ÏÑ±Ïû• Îã®Í≥Ñ'],
    feedbackRequired: 'ÌîºÎìúÎ∞± Ï†êÏàòÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.'
  },
  en: {
    resultTitle: 'üéâ GQ Test Results',
    totalScore: 'Total Score',
    growthStage: 'Growth Stage',
    growthDesc: 'Description',
    summary: 'üß© Summary Message',
    areaAnalysis: 'üìå Area Analysis',
    shape: 'üìê Shape Analysis',
    recs: 'üí° Recommendations',
    feedbackTitle: 'üó£Ô∏è How was this test for you?',
    feedbackScore: 'Please rate your satisfaction (1-5):',
    feedbackPlaceholder: 'Any feedback? (Optional)',
    feedbackSubmit: 'Submit Feedback',
    feedbackThanks: 'Thank you for your feedback!',
    feedbackError: 'An error occurred while saving.',
    feedbackAlert: 'Survey must be saved first.',
    level: 'Level',
    percent: '%',
    score: 'Score',
    area: 'Area',
    personalFeedback: 'Personal Feedback',
    shapeType: 'Shape Type',
    areaLabel: area => area.replace('GQ-', ''),
    description: 'Description',
    submitDisabled: 'Please select a satisfaction score.',
    tableHeaders: ['Area', 'Score', '%', 'Level', 'Personal Feedback'],
    shapeDetail: ['Shape Type', 'Description', 'Area', 'Std Dev', 'Delta', 'Growth Stage'],
    feedbackRequired: 'Please select a satisfaction score.'
  }
};

const cellStyle = {
  border: '1px solid #e0e0e0',
  padding: '12px 10px',
  textAlign: 'center',
  fontSize: '0.95rem',
  verticalAlign: 'middle',
};
const headerStyle = {
  ...cellStyle,
  backgroundColor: '#f5f5f5',
  fontWeight: 'bold',
  color: '#333'
};
const rowStyle = {
  backgroundColor: '#ffffff'
};

// Ï†êÏàò ‚Üí Î†àÎ≤® (I~IV)
function getLevel(score) {
  if (score >= 17) return 'IV';
  if (score >= 14) return 'III';
  if (score >= 11) return 'II';
  return 'I';
}

const personalFeedback = {
  'GQ-Drive': {
    I: ['ÎÇ¥Ï†Å ÎèôÍ∏∞ ÌôúÏÑ±Ìôî ÌïÑÏöî‚ÄîÎèôÎ£åÏôÄ Ìï®Íªò ÎèôÍ∏∞Î•º ÎÇòÎàÑÎäî Í≤ΩÌóò Í∂åÏû•', 'Needs to activate intrinsic motivation‚Äîtry sharing motivation with colleagues.'],
    II: ['Í∏∞Î≥∏Ï†ÅÏù∏ ÏùòÏßÄÎäî ÏûàÏúºÎÇò Î™©ÌëúÏùòÏãùÍ≥º Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌï®', 'Basic will exists but needs stronger sense of purpose.'],
    III: ['ÎÜíÏùÄ ÎÇ¥Ï†Å ÎèôÍ∏∞‚ÄîÌåÄÏóê Ïó¥Ï†ï Ï†ÑÌåå Ïó≠Ìï† Í∏∞ÎåÄ', 'High intrinsic motivation‚Äîexpected to inspire the team.'],
    IV: ['ÏÇ¨Î™ÖÍ∞ê Í∏∞Î∞òÏùò Î™∞ÏûÖÍ≥º ÎèôÍ∏∞ ÏóêÎÑàÏßÄ Ï§ëÏã¨Ï∂ï Ïó≠Ìï† Í∞ÄÎä•', 'Mission-driven focus and key motivational anchor.'],
  },
  'GQ-Knowledge': {
    I: ['Ï†ïÏ±Ö Ïñ∏Ïñ¥ Î∞è ÏòàÏÇ∞ Íµ¨Ï°∞ ÌïôÏäµ ÌïÑÏöî‚ÄîÏã§Ï†Ñ ÏòàÏãú ÎÖ∏Ï∂ú Ï∂îÏ≤ú', 'Needs to learn policy terms and budget structure‚Äîpractice with real examples.'],
    II: ['RFP Íµ¨Ï°∞¬∑ÏòàÏÇ∞ Ìé∏ÏÑ± Ïã§Ï†Ñ ÏÇ¨Î°Ä ÌïôÏäµ ÌïÑÏöî', 'Needs case studies of RFP structure and budgeting.'],
    III: ['Ï†ïÏ±Ö Î¨∏Îß• Ìï¥ÏÑù Îä•Î†• ÏñëÌò∏‚ÄîÍµ¨Ï°∞ÏôÄ ÏàòÏöî Ìï¥ÏÑù Í∞ÄÎä•', 'Good at interpreting policy context and understanding structure and demand.'],
    IV: ['Î≥µÌï© Ï†ïÏ±Ö Íµ¨Ï°∞ÏôÄ ÏàòÏöî Ïó∞Í≤∞Ïóê ÌÜµÌï©Ï†Å Ìï¥ÏÑù Í∞ÄÎä•', 'Can integratively analyze complex policy structure and needs.'],
  },
  'GQ-Strategy': {
    I: ['Î¨∏Ï†ú Ï†ïÏùò/Ï∞®Î≥ÑÌôî Ï†ÑÎûµ Í∞êÍ∞Å Í∞úÎ∞ú ÌïÑÏöî', 'Needs to develop problem definition/differentiation strategy.'],
    II: ['ÎÖºÎ¶¨Ï†Å Íµ¨ÏÑ±Î†•ÏùÄ ÏûàÏúºÎÇò Ï†ÑÎûµÏ†Å Í∞êÍ∞Å Î≥¥ÏôÑ ÌïÑÏöî', 'Logical structure is present, but needs strategic sense.'],
    III: ['Ï†ÑÎûµ ÌùêÎ¶Ñ Í∏∞Ìöç Í∞ÄÎä•‚ÄîÏ†úÏïàÏÑú Í≥®Í≤© ÏÑ§Í≥Ñ Îä•Î†• Î≥¥Ïú†', 'Can plan strategy flow and design proposal structure.'],
    IV: ['ÌÉÅÏõîÌïú Î©îÌÉÄ-Ï†ÑÎûµ Í∞êÍ∞Å‚ÄîÌè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏÑ§Í≥ÑÏóê Ï∞∏Ïó¨', 'Excellent meta-strategic sense‚Äîcan participate in portfolio design.'],
  },
  'GQ-Action': {
    I: ['Ïã§Ìñâ Í∑ºÎ†• Î≥¥Í∞ï‚ÄîÎ™®Ïùò Ï†úÏïàÏÑú¬∑ÏΩîÏπ≠ ÏÑ∏ÏÖò Ï∂îÏ≤ú', 'Needs to strengthen execution‚Äîpractice/mock proposals and coaching.'],
    II: ['Ï∂îÏßÑÎ†• ÏûàÏùå‚ÄîÎ¶¨ÏÜåÏä§ Î∂ÑÎ∞∞ÏôÄ ÏùºÏ†ï ÏÑ§Í≥Ñ Ï∂îÍ∞Ä ÌïÑÏöî', 'Has drive‚Äîneeds to improve resource allocation and scheduling.'],
    III: ['Í∏∞Ï¥à Ïã§Ìñâ Íµ¨Ï°∞ Ïù¥Ìï¥Ìï®‚ÄîÌåÄ ÎÇ¥ Ïã§Ìñâ Î¶¨Îçî Í∞ÄÎä•', 'Understands execution basics‚Äîcan lead team implementation.'],
    IV: ['Ïã§Ìñâ Ï°∞Ïú®Î†• Í∞ïÌï®‚ÄîÎ≥µÏû° ÌîÑÎ°úÏ†ùÌä∏ Ïö¥ÏòÅ Îä•Î†• Ïö∞Ïàò', 'Strong at execution coordination‚Äîexcellent in complex projects.'],
  },
};



const ResultPage = ({ answers, name, position }) => {
  const { lang } = useParams();
  const t = TEXTS[lang] || TEXTS.ko;
  const [docId, setDocId] = useState(null);
  const [feedbackScore, setFeedbackScore] = useState(null);
  const [feedbackText, setFeedbackText] = useState('');

  const scores = calculateCategoryScores(answers);
  const totalScore = Object.values(scores).reduce((a, b) => a + b, 0);
  const growthStage = getGrowthStage(totalScore, lang);
  const shapeInfo = analyzeShapeAndGrowth(scores, lang);
  const gqType = getGQType(scores, lang);

  const data = {
    labels: Object.keys(scores),
    datasets: [
      {
        label: 'GQ Score',
        data: Object.values(scores),
        backgroundColor: 'rgba(0, 123, 255, 0.2)',
        borderColor: 'rgba(0, 123, 255, 1)',
        borderWidth: 2,
        pointBackgroundColor: 'rgba(0, 123, 255, 1)',
      },
    ],
  };
  const options = {
    scales: {
      r: {
        beginAtZero: true,
        max: 20,
        ticks: { stepSize: 5 },
        pointLabels: { font: { size: 14 } },
      },
    },
  };

  useEffect(() => {
    const saveInitialResponse = async () => {
      try {
        const docRef = await addDoc(collection(db, 'gq_responses'), {
          name,
          position,
          scores,
          totalScore,
          lang,
          createdAt: new Date().toISOString()
        });
        setDocId(docRef.id);
      } catch (error) {
        // ÏóêÎü¨ Î°úÍ∑∏
      }
    };
    saveInitialResponse();
    // eslint-disable-next-line
  }, []);

  return (
    <div style={{ padding: 20 }}>
      <h2>{t.resultTitle}</h2>
      <p>
        <strong>{name}</strong> / {position}
      </p>
      <p>
        {t.totalScore}: {totalScore} / 80
      </p>
      <p>
        <strong>{t.growthStage}:</strong> {growthStage.level}
      </p>
      <p style={{ fontStyle: 'italic', color: '#555' }}>{growthStage.message}</p>

      <Radar data={data} options={options} />

      <h3 style={{ marginTop: '2rem' }}>{t.summary}</h3>
      <div
        style={{
          backgroundColor: '#f8f8fc',
          padding: '1.2rem',
          borderRadius: '10px',
          border: '1px solid #ddd',
          lineHeight: 1.6
        }}
      >
        {getSummaryMessage(scores, lang)}
      </div>

      <h3 style={{ marginTop: '2rem' }}>{t.areaAnalysis}</h3>
      <table
        style={{
          width: '100%',
          borderCollapse: 'collapse',
          marginTop: '1rem',
          boxShadow: '0 2px 6px rgba(0,0,0,0.05)',
          borderRadius: '8px',
          overflow: 'hidden'
        }}
      >
        <thead>
          <tr>
            {t.tableHeaders.map((h, i) => (
              <th style={headerStyle} key={i}>{h}</th>
            ))}
          </tr>
        </thead>
        <tbody>
          {Object.entries(scores).map(([area, score]) => {
            const level = getLevel(score);
            const percent = Math.round((score / 20) * 100);
            const feedbackMsg = personalFeedback[area]?.[level][lang === 'en' ? 1 : 0];
            return (
              <tr key={area} style={rowStyle}>
                <td style={cellStyle}>{t.areaLabel(area)}</td>
                <td style={cellStyle}>{score}</td>
                <td style={cellStyle}>{percent} {t.percent}</td>
                <td style={cellStyle}>{t.level} {level}</td>
                <td style={{ ...cellStyle, textAlign: 'left' }}>{feedbackMsg}</td>
              </tr>
            );
          })}
        </tbody>
      </table>

      <h3 style={{ marginTop: '2rem' }}>{t.shape}</h3>
      <div
        style={{
          backgroundColor: '#fefefe',
          padding: '1.2rem',
          borderRadius: '10px',
          border: '1px solid #ddd',
          lineHeight: 1.6
        }}
      >
        <p>
          <strong>{t.shapeDetail[0]}:</strong> {shapeInfo.shape}
        </p>
        <p>
          <strong>{t.shapeDetail[1]}:</strong> {shapeInfo.shapeMessage}
        </p>
        <p>
          <strong>{t.shapeDetail[2]}:</strong> {shapeInfo.area} (standardized)
        </p>
        <p>
          <strong>{t.shapeDetail[3]}:</strong> {shapeInfo.sigma}, <strong>{t.shapeDetail[4]}:</strong> {shapeInfo.delta}
        </p>
        <p>
          <strong>{t.shapeDetail[5]}:</strong> {shapeInfo.growth}
        </p>
      </div>

      <h3 style={{ marginTop: '2rem' }}>{t.recs}</h3>
      {Object.entries(scores).map(([area, score]) => {
        const level = getLevel(score);
        const areaLabel = t.areaLabel(area);
        if (level === 'I' || level === 'II') {
          const recs = recommendations[area]?.[level];
          return (
            <div
              key={area}
              style={{
                marginBottom: '1rem',
                padding: '1rem',
                background: '#f9f9f9',
                border: '1px solid #eee',
                borderRadius: '8px'
              }}
            >
              <p>
                <strong>{areaLabel}</strong>{' '}
                {lang === 'en'
                  ? 'Recommendations for improvement:'
                  : 'ÏòÅÏó≠ Î≥¥ÏôÑÏùÑ ÏúÑÌïú Ï∂îÏ≤ú ÌôúÎèô:'}
              </p>
              <ul style={{ marginTop: '0.5rem' }}>
                {recs?.map((item, idx) => (
                  <li key={idx}>üîπ {item[lang]}</li>
                ))}
              </ul>
            </div>
          );
        } else {
          return null;
        }
      })}

      <div style={{ marginTop: '3rem' }}>
        <h3>{t.feedbackTitle}</h3>

        <p style={{ marginBottom: '0.5rem' }}>{t.feedbackScore}</p>
        <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem' }}>
          {[1, 2, 3, 4, 5].map((score) => (
            <button
              key={score}
              onClick={() => setFeedbackScore(score)}
              style={{
                padding: '0.5rem 1rem',
                backgroundColor: feedbackScore === score ? '#0070f3' : '#eee',
                color: feedbackScore === score ? '#fff' : '#333',
                border: 'none',
                borderRadius: '6px',
                cursor: 'pointer'
              }}
            >
              {score}
              {lang === 'en' ? '' : 'Ï†ê'}
            </button>
          ))}
        </div>

        <textarea
          placeholder={t.feedbackPlaceholder}
          value={feedbackText}
          onChange={(e) => setFeedbackText(e.target.value)}
          style={{
            width: '100%',
            height: '80px',
            padding: '0.8rem',
            border: '1px solid #ccc',
            borderRadius: '8px',
            marginBottom: '1rem'
          }}
        />

        <button
          onClick={async () => {
            if (!docId) {
              alert(t.feedbackAlert);
              return;
            }
            if (!feedbackScore) {
              alert(t.feedbackRequired);
              return;
            }
            try {
              const docRef = doc(db, 'gq_responses', docId);
              await updateDoc(docRef, {
                feedbackScore,
                feedbackText,
                feedbackAt: new Date().toISOString()
              });
              alert(t.feedbackThanks);
              setFeedbackScore(null);
              setFeedbackText('');
            } catch (error) {
              alert(t.feedbackError);
            }
          }}
          style={{
            backgroundColor: '#10b981',
            color: 'white',
            border: 'none',
            padding: '10px 20px',
            borderRadius: '8px',
            cursor: 'pointer'
          }}
          disabled={!feedbackScore}
        >
          {t.feedbackSubmit}
        </button>
      </div>
    </div>
  );
};

// Ïú†Ìòï Î∂ÑÎ•ò (Îã§Íµ≠Ïñ¥)
function getGQType(scores, lang) {
  if (scores['GQ-Strategy'] >= 18 && scores['GQ-Action'] >= 17) {
    return {
      name: lang === 'en'
        ? 'Strategic Implementer'
        : 'Ï†ÑÎûµÏ†Å Ïã§ÌñâÍ∞Ä (Strategic Implementer)',
      description:
        lang === 'en'
          ? 'Strong logical thinking, strategic judgment, execution, and motivation.'
          : 'ÎÖºÎ¶¨Ï†Å ÏÇ¨Í≥†, Ï†ÑÎûµÏ†Å ÌåêÎã®, Ïã§ÌñâÎ†•Í≥º ÎÇ¥Ï†Å ÎèôÍ∏∞Í∞Ä Í∞ïÌïú Ïú†ÌòïÏûÖÎãàÎã§.',
    };
  }
  return {
    name: lang === 'en' ? 'GQ Growth Type' : 'GQ ÏÑ±Ïû•Ìòï',
    description:
      lang === 'en'
        ? 'Has potential, needs further development in some areas.'
        : 'Ïû†Ïû¨Î†•Ïù¥ ÏûàÏúºÎ©∞ ÏùºÎ∂Ä ÏòÅÏó≠ÏóêÏÑú Ïã¨ÌôîÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.',
  };
}

export default ResultPage;
